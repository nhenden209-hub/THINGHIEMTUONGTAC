<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√¥ Ph·ªèng N√∫i L·ª≠a 3D - ƒê·ªãa L√Ω 6</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        /* Giao di·ªán ƒëi·ªÅu khi·ªÉn - ƒê√£ chuy·ªÉn sang g√≥c TR√ÅI */
        #ui-layer {
            position: absolute;
            top: 15px;
            left: 15px; /* ƒê·∫∑t b√™n tr√°i */
            right: auto; /* H·ªßy b√™n ph·∫£i */
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(4px);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 220px;
            pointer-events: auto;
            transition: background 0.3s;
        }

        #ui-layer:hover {
            background: rgba(255, 255, 255, 0.95);
        }
        
        h1 { margin: 0 0 8px 0; font-size: 18px; color: #c0392b; text-align: center; }
        p { font-size: 12px; color: #333; margin-bottom: 12px; text-align: center; font-style: italic; }
        
        button {
            display: block;
            width: 100%;
            padding: 8px;
            margin: 6px 0;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        
        .btn-earthquake { background-color: #f39c12; color: white; }
        .btn-earthquake:hover { background-color: #d35400; }
        
        .btn-erupt { background-color: #e74c3c; color: white; }
        .btn-erupt:hover { background-color: #c0392b; }
        
        .btn-reset { background-color: #34495e; color: white; }
        .btn-reset:hover { background-color: #2c3e50; }

        .btn-cutaway { background-color: #3498db; color: white; }
        .btn-cutaway:hover { background-color: #2980b9; }

        /* Nh√£n 3D */
        .label {
            position: absolute;
            background: rgba(0, 0, 0, 0.5); 
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            pointer-events: none;
            user-select: none;
            font-weight: bold;
            display: none;
            white-space: nowrap;
            text-shadow: 1px 1px 2px black;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        /* M≈©i t√™n nh·ªè b√™n tr√°i nh√£n */
        .label::before {
            content: '‚óÑ'; 
            margin-right: 5px;
            color: #FFD700;
            font-size: 10px;
        }

        #loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            pointer-events: none;
        }

        #status {
            margin-top: 10px; 
            font-style: italic; 
            color: #d35400; 
            font-size: 13px; 
            text-align: center;
            font-weight: bold;
            border-top: 1px solid #ccc;
            padding-top: 5px;
        }
    </style>
    <!-- Import Three.js t·ª´ CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

    <div id="loading">ƒêang t·∫£i m√¥ h√¨nh 3D...</div>

    <!-- Container cho 3D Canvas -->
    <div id="canvas-container"></div>

    <!-- C√°c nh√£n n·ªïi -->
    <div id="label-magma" class="label">L√≤ Mac-ma</div>
    <div id="label-vent" class="label">·ªêng phun</div>
    <div id="label-crater" class="label">Mi·ªáng n√∫i l·ª≠a</div>

    <!-- B·∫£ng ƒëi·ªÅu khi·ªÉn -->
    <div id="ui-layer">
        <h1>M√¥ H√¨nh N√∫i L·ª≠a 3D</h1>
        <p>Xoay: Chu·ªôt tr√°i | Zoom: LƒÉn chu·ªôt</p>
        
        <button class="btn-cutaway" onclick="toggleCutaway()">üëÅÔ∏è B·∫≠t/T·∫Øt M·∫∑t C·∫Øt</button>
        <button class="btn-earthquake" onclick="triggerEarthquake()">1. Rung ch·∫•n (D·∫•u hi·ªáu)</button>
        <button class="btn-erupt" onclick="triggerEruption()">2. Phun tr√†o dung nham</button>
        <button class="btn-reset" onclick="resetSim()">L√†m m·ªõi</button>
        
        <div id="status">
            Tr·∫°ng th√°i: Ng·ªß y√™n
        </div>
    </div>

    <script>
        // --- C·∫§U H√åNH C∆† B·∫¢N ---
        let scene, camera, renderer, controls;
        let volcanoMesh, magmaChamber, mainVent, lavaSurface;
        let particles = [], smokeParticles = [], risingMagmaParticles = [];
        let annotationLines = []; // M·∫£ng ch·ª©a c√°c ƒë∆∞·ªùng k·∫ª ch√∫ th√≠ch
        let isErupting = false;
        let isShaking = false;
        let isCutaway = true; // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã m·∫∑t c·∫Øt
        
        const canvasContainer = document.getElementById('canvas-container');
        const statusDiv = document.getElementById('status');
        
        // C·∫¨P NH·∫¨T V·ªä TR√ç NH√ÉN: D·ªùi sang b√™n ph·∫£i (x d∆∞∆°ng) ƒë·ªÉ tr√°nh che h√¨nh
        const labels = {
            magma: { el: document.getElementById('label-magma'), pos: new THREE.Vector3(7, -5, 0), target: new THREE.Vector3(0, -5, 0) },
            vent: { el: document.getElementById('label-vent'), pos: new THREE.Vector3(7, 0, 0), target: new THREE.Vector3(0.5, 0, 0) },
            crater: { el: document.getElementById('label-crater'), pos: new THREE.Vector3(7, 5, 0), target: new THREE.Vector3(1.5, 5, 0) }
        };

        // --- KH·ªûI T·∫†O SCENE ---
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); 
            scene.fog = new THREE.Fog(0x87CEEB, 20, 100);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 8, 35); // G√≥c nh√¨n tr·ª±c di·ªán h∆°n

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            canvasContainer.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.maxPolarAngle = Math.PI / 2 - 0.1;
            controls.minDistance = 10;
            controls.maxDistance = 60;

            // √Ånh s√°ng
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(50, 50, 50);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // ƒê√®n m√†u cam t·ª´ l√≤ mac-ma
            const magmaLight = new THREE.PointLight(0xff4500, 2, 20);
            magmaLight.position.set(0, -2, 0);
            scene.add(magmaLight);

            createEnvironment();
            createVolcano();
            createAnnotations(); // V·∫Ω ƒë∆∞·ªùng ch√∫ th√≠ch
            
            document.getElementById('loading').style.display = 'none';
            Object.values(labels).forEach(l => l.el.style.display = 'block');

            animate();
        }

        // --- V·∫º ƒê∆Ø·ªúNG CH√ö TH√çCH (Annotation Lines) ---
        function createAnnotations() {
            // Xo√° ƒë∆∞·ªùng c≈© n·∫øu c√≥
            annotationLines.forEach(line => scene.remove(line));
            annotationLines = [];

            const material = new THREE.LineBasicMaterial({ 
                color: 0xFFFFFF, 
                transparent: true, 
                opacity: 0.4,
                dashSize: 0.5, 
                gapSize: 0.2
            });

            // V·∫Ω ƒë∆∞·ªùng t·ª´ v·ªã tr√≠ nh√£n (pos) ƒë·∫øn v·ªã tr√≠ v·∫≠t th·ªÉ (target)
            for (const key in labels) {
                const l = labels[key];
                const points = [];
                points.push(l.target); // ƒêi·ªÉm b·∫Øt ƒë·∫ßu (v·∫≠t th·ªÉ)
                points.push(l.pos);    // ƒêi·ªÉm k·∫øt th√∫c (nh√£n)

                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const line = new THREE.Line(geometry, material);
                scene.add(line);
                annotationLines.push(line);
                
                // Th√™m ch·∫•m tr√≤n nh·ªè ·ªü ƒëi·ªÉm ti·∫øp x√∫c v·∫≠t th·ªÉ
                const dotGeo = new THREE.SphereGeometry(0.1, 8, 8);
                const dotMat = new THREE.MeshBasicMaterial({ color: 0xFFFFFF });
                const dot = new THREE.Mesh(dotGeo, dotMat);
                dot.position.copy(l.target);
                scene.add(dot);
                annotationLines.push(dot);
            }
        }

        function createEnvironment() {
            const groundGeo = new THREE.PlaneGeometry(200, 200);
            const groundMat = new THREE.MeshLambertMaterial({ color: 0x4CAF50 });
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -5;
            ground.receiveShadow = true;
            scene.add(ground);
        }

        // --- T·∫†O N√öI L·ª¨A ---
        function createVolcano() {
            let geometry;
            
            if (isCutaway) {
                // T·∫°o n·ª≠a sau c·ªßa ng·ªçn n√∫i. 
                geometry = new THREE.CylinderGeometry(1.5, 12, 10, 32, 1, false, Math.PI, Math.PI);
                statusDiv.innerText = "Ch·∫ø ƒë·ªô: M·∫∑t c·∫Øt (Th·∫•y b√™n trong)";
                
                if (!mainVent) {
                    const ventGeo = new THREE.CylinderGeometry(0.5, 0.8, 10.1, 16);
                    const ventMat = new THREE.MeshBasicMaterial({ 
                        color: 0x8B0000, 
                        transparent: true, 
                        opacity: 0.2, // R·∫•t trong ƒë·ªÉ th·∫•y d√≤ng ch·∫£y
                        depthWrite: false 
                    });
                    mainVent = new THREE.Mesh(ventGeo, ventMat);
                    scene.add(mainVent);
                }
                mainVent.visible = true;

            } else {
                // To√†n c·∫£nh (360 ƒë·ªô)
                geometry = new THREE.CylinderGeometry(1.5, 12, 10, 32, 1, false, 0, Math.PI * 2);
                statusDiv.innerText = "Ch·∫ø ƒë·ªô: To√†n c·∫£nh";
                if (mainVent) mainVent.visible = false; // ·∫®n ·ªëng phun khi nh√¨n b√™n ngo√†i
            }
            
            if (volcanoMesh) scene.remove(volcanoMesh);

            const materialOutside = new THREE.MeshLambertMaterial({ color: 0x5D4037, side: THREE.DoubleSide });
            volcanoMesh = new THREE.Mesh(geometry, materialOutside);
            volcanoMesh.position.y = 0;
            volcanoMesh.castShadow = true;
            volcanoMesh.receiveShadow = true;
            volcanoMesh.rotation.y = 0; 
            
            scene.add(volcanoMesh);

            if (!magmaChamber) {
                const chamberGeo = new THREE.SphereGeometry(3, 32, 32);
                const chamberMat = new THREE.MeshBasicMaterial({ color: 0xFF0000 });
                magmaChamber = new THREE.Mesh(chamberGeo, chamberMat);
                magmaChamber.position.y = -5;
                magmaChamber.scale.y = 0.6;
                scene.add(magmaChamber);
            }

            if (!lavaSurface) {
                const craterGeo = new THREE.CircleGeometry(1.4, 32);
                const craterMat = new THREE.MeshBasicMaterial({ color: 0xFF4500 });
                lavaSurface = new THREE.Mesh(craterGeo, craterMat);
                lavaSurface.rotation.x = -Math.PI / 2;
                lavaSurface.position.y = 5.05;
                scene.add(lavaSurface);
            }
        }

        // --- LOGIC H·∫†T ---
        function createSmoke() {
            const particleGeo = new THREE.SphereGeometry(0.2 + Math.random() * 0.3, 8, 8);
            const particleMat = new THREE.MeshLambertMaterial({ color: 0x7f8c8d, transparent: true, opacity: 0.6 });
            const particle = new THREE.Mesh(particleGeo, particleMat);
            particle.position.set((Math.random()-0.5), 5.5, (Math.random()-0.5));
            particle.userData = {
                velocity: new THREE.Vector3((Math.random()-0.5)*0.1, 0.1+Math.random()*0.2, (Math.random()-0.5)*0.1),
                life: 1.0
            };
            scene.add(particle);
            smokeParticles.push(particle);
        }

        function createRisingMagma() {
            const size = 0.25; 
            const particleGeo = new THREE.SphereGeometry(size, 8, 8);
            const particleMat = new THREE.MeshBasicMaterial({ color: 0xFF0000 }); 
            const particle = new THREE.Mesh(particleGeo, particleMat);
            
            const angle = Math.random() * Math.PI * 2;
            const r = Math.random() * 0.3;
            particle.position.set(Math.cos(angle)*r, -5, Math.sin(angle)*r);
            
            particle.userData = { speedY: 0.2 + Math.random() * 0.1 };
            scene.add(particle);
            risingMagmaParticles.push(particle);
        }

        function createLava() {
            const size = 0.2 + Math.random() * 0.1;
            const particleGeo = new THREE.SphereGeometry(size, 8, 8);
            const particleMat = new THREE.MeshBasicMaterial({ color: 0xFF0000 });
            const particle = new THREE.Mesh(particleGeo, particleMat);
            particle.position.set(0, 5, 0);
            
            const angle = Math.random() * Math.PI * 2;
            const force = 0.3 + Math.random() * 0.3;
            particle.userData = {
                velocity: new THREE.Vector3(Math.cos(angle)*force, 0.3 + Math.random()*0.3, Math.sin(angle)*force),
                gravity: 0.02,
                type: 'lava'
            };
            scene.add(particle);
            particles.push(particle);
        }

        // --- ƒêI·ªÄU KHI·ªÇN ---
        function toggleCutaway() {
            isCutaway = !isCutaway;
            createVolcano(); 
        }

        function triggerEarthquake() {
            isShaking = true;
            statusDiv.innerText = "Hi·ªán t∆∞·ª£ng: ƒê·ªông ƒë·∫•t & Kh√≥i";
            if (!animationId) animate(); 
        }

        function triggerEruption() {
            if(!isShaking) triggerEarthquake();
            isErupting = true;
            isShaking = false;
            statusDiv.innerText = "Hi·ªán t∆∞·ª£ng: PHUN TR√ÄO!";
            
            if(mainVent) mainVent.material.color.setHex(0xFF4500);
            lavaSurface.material.color.setHex(0xFF0000); 
        }

        function resetSim() {
            isErupting = false;
            isShaking = false;
            statusDiv.innerText = "Tr·∫°ng th√°i: Ng·ªß y√™n";
            
            [...particles, ...smokeParticles, ...risingMagmaParticles].forEach(p => scene.remove(p));
            particles = []; smokeParticles = []; risingMagmaParticles = [];
            
            if(mainVent) mainVent.material.color.setHex(0x8B0000);
            lavaSurface.material.color.setHex(0xFF4500);
            camera.position.set(0, 8, 35);
        }

        // --- ANIMATION LOOP ---
        let animationId;
        function animate() {
            animationId = requestAnimationFrame(animate);
            controls.update();

            if (isShaking) {
                camera.position.x += (Math.random() - 0.5) * 0.2;
                camera.position.y += (Math.random() - 0.5) * 0.2;
                if (Math.random() < 0.3) createSmoke();
            }

            if (isErupting) {
                if (isCutaway) {
                    for(let k=0; k<5; k++) createRisingMagma();
                }
                for(let k=0; k<3; k++) createLava();
                if (Math.random() < 0.5) createSmoke();
                
                const s = 1 + Math.sin(Date.now()*0.01)*0.05;
                magmaChamber.scale.set(s, s*0.6, s);
            }

            for (let i = risingMagmaParticles.length - 1; i >= 0; i--) {
                const p = risingMagmaParticles[i];
                p.position.y += p.userData.speedY;
                if (p.position.y > 5) { 
                    scene.remove(p);
                    risingMagmaParticles.splice(i, 1);
                }
            }

            for (let i = smokeParticles.length - 1; i >= 0; i--) {
                const p = smokeParticles[i];
                p.position.add(p.userData.velocity);
                p.userData.life -= 0.01;
                p.material.opacity = p.userData.life * 0.5;
                p.scale.multiplyScalar(1.02);
                if (p.userData.life <= 0) {
                    scene.remove(p);
                    smokeParticles.splice(i, 1);
                }
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                const dist = Math.sqrt(p.position.x**2 + p.position.z**2);
                const mountainR = (5 - p.position.y) * 1.2 + 1.5;

                if (p.position.y < 5 && p.position.y > -5 && dist < mountainR + 0.5) {
                    const angle = Math.atan2(p.position.z, p.position.x);
                    const r = mountainR + 0.1;
                    p.position.x = Math.cos(angle) * r;
                    p.position.z = Math.sin(angle) * r;
                    p.position.y -= 0.15; 
                    p.material.color.setHex(0xB22222); 
                } else {
                    p.userData.velocity.y -= p.userData.gravity;
                    p.position.add(p.userData.velocity);
                }

                if (p.position.y < -5) {
                    scene.remove(p);
                    particles.splice(i, 1);
                }
            }

            updateLabels();
            renderer.render(scene, camera);
        }

        function updateLabels() {
            const w = window.innerWidth, h = window.innerHeight;
            for (const key in labels) {
                const l = labels[key];
                const v = l.pos.clone();
                v.project(camera);
                if (v.z > 1) {
                    l.el.style.display = 'none';
                } else {
                    l.el.style.display = 'block';
                    l.el.style.left = (v.x * w/2 + w/2) + 'px';
                    l.el.style.top = (-v.y * h/2 + h/2) + 'px';
                }
            }
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        init();
    </script>
</body>
</html>